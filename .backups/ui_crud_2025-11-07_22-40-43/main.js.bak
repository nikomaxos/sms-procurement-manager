(() => {
  const $ = (s) => document.querySelector(s);
  const root = $("#root"), nav = $("#nav");
  const API = `http://${location.hostname}:8010`;

  const token = () => localStorage.getItem("token") || "";
  const setToken = (t) => localStorage.setItem("token", t);
  const clearToken = () => localStorage.removeItem("token");

  async function authFetch(path, opts={}) {
    const headers = Object.assign(
      {"Content-Type":"application/json","Authorization":"Bearer "+token()},
      opts.headers||{}
    );
    const res = await fetch(API + path, {...opts, headers});
    if (res.status === 401) throw new Error("Unauthorized");
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function showLogin() {
    nav.hidden = true;
    root.innerHTML = `
      <h2>Login</h2>
      <div class="row">
        <div><label>Username</label><input id="u" value="admin"></div>
        <div><label>Password</label><input id="p" type="password" value="admin123"></div>
      </div>
      <div class="actions"><button class="primary" id="loginBtn">Login</button></div>
      <div id="msg" class="error"></div>
    `;
    $("#loginBtn").onclick = async () => {
      $("#msg").textContent = "";
      try {
        const r = await fetch(API + "/users/login", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({username: $("#u").value.trim(), password: $("#p").value})
        });
        if (!r.ok) throw new Error(`Login failed (${r.status})`);
        const j = await r.json();
        if (!j.access_token) throw new Error("No token");
        setToken(j.access_token);
        render("dashboard");
      } catch(e){ $("#msg").textContent = e.message; }
    };
  }

  async function viewDashboard() {
    const d = new Date().toISOString().slice(0,10);
    const trends = await authFetch(`/metrics/trends?d=${d}`).catch(()=>({date:d, series:[]}));
    root.innerHTML = `<h2>Dashboard</h2>
      <p class="muted">Date: ${trends.date}</p>
      <pre>${JSON.stringify(trends.series||[], null, 2)}</pre>`;
  }

  async function viewOffers() {
    const r = await authFetch(`/offers/?limit=50&offset=0`).catch(()=>({items:[]}));
    root.innerHTML = `<h2>Offers</h2><pre>${JSON.stringify(r, null, 2)}</pre>`;
  }

  // ---------- Settings helpers ----------
  function tabs(active) {
    return `
      <div class="actions" style="display:flex;gap:8px;margin-bottom:12px">
        <button data-tab="catalog" ${active==='catalog'?'class="primary"':''}>Catalog</button>
        <button data-tab="imap" ${active==='imap'?'class="primary"':''}>Email (IMAP)</button>
        <button data-tab="scraper" ${active==='scraper'?'class="primary"':''}>Scraper</button>
      </div>
    `;
  }
  function pills(arr) {
    return `<div style="display:flex;flex-wrap:wrap;gap:6px">
      ${arr.map(x=>`<span style="padding:4px 8px;border:1px solid #374151;border-radius:999px;background:#0b1220">${x}</span>`).join("")}
    </div>`;
  }
  function chipEditor(label, id, values) {
    const val = (values||[]).join(", ");
    return `
      <label>${label}</label>
      <input id="${id}" placeholder="Comma-separated" value="${val}">
      <div class="muted" style="margin-top:4px">Press Save Catalog to persist.</div>
    `;
  }

  async function viewSettings(activeTab='catalog') {
    // Load everything up-front (fast and simple)
    const [e, im, sc] = await Promise.all([
      authFetch(`/conf/enums`),
      authFetch(`/settings/imap`).catch(()=>({})),
      authFetch(`/settings/scrape`).catch(()=>({}))
    ]);

    // ---- Build tab contents ----
    const catalogHTML = `
      ${tabs('catalog')}
      <h2>Settings · Catalog</h2>
      <div class="row">
        <div>
          <h3>Countries</h3>
          ${pills(e.countries||[])}
          ${chipEditor("Edit countries", "cat_countries", e.countries)}
        </div>
        <div>
          <h3>MCCMNC</h3>
          ${pills(e.mccmnc||[])}
          ${chipEditor("Edit MCCMNC", "cat_mccmnc", e.mccmnc)}
        </div>
        <div>
          <h3>Vendors</h3>
          ${pills(e.vendors||[])}
          ${chipEditor("Edit vendors", "cat_vendors", e.vendors)}
        </div>
        <div>
          <h3>Tags</h3>
          ${pills(e.tags||[])}
          ${chipEditor("Edit tags", "cat_tags", e.tags)}
        </div>
      </div>
      <div class="actions"><button id="saveCatalog" class="primary">Save Catalog</button></div>
      <div id="msgCat" class="ok"></div>
    `;

    const imapHTML = `
      ${tabs('imap')}
      <h2>Settings · Email (IMAP)</h2>
      <div class="row">
        <div><label>Host</label><input id="im_host" value="${im.host||""}"></div>
        <div><label>Port</label><input id="im_port" type="number" value="${im.port??993}"></div>
        <div><label>Username</label><input id="im_user" value="${im.username||""}"></div>
        <div><label>Password</label><input id="im_pass" type="password" value="${im.password||""}"></div>
        <div><label>SSL</label><input id="im_ssl" type="checkbox" ${im.ssl?"checked":""}></div>
        <div><label>Folder</label><input id="im_folder" value="${im.folder||"INBOX"}"></div>
        <div><label>Enabled</label><input id="im_enabled" type="checkbox" ${im.enabled?"checked":""}></div>
      </div>
      <div class="actions"><button id="saveImap" class="primary">Save IMAP</button></div>
      <div id="msgImap" class="ok"></div>
    `;

    const scraperHTML = `
      ${tabs('scraper')}
      <h2>Settings · Scraper</h2>
      <div class="row">
        <div><label>Enabled</label><input id="sc_enabled" type="checkbox" ${sc.enabled?"checked":""}></div>
        <div><label>Interval (min)</label><input id="sc_interval" type="number" value="${sc.interval_minutes??30}"></div>
        <div><label>User-Agent</label><input id="sc_ua" value="${sc.user_agent||"Mozilla/5.0"}"></div>
        <div><label>Max Concurrency</label><input id="sc_conc" type="number" value="${sc.max_concurrency??4}"></div>
      </div>
      <label>Start URLs (one per line)</label><textarea id="sc_urls">${(sc.start_urls||[]).join("\n")}</textarea>
      <label>Allow Domains (one per line)</label><textarea id="sc_allow">${(sc.allow_domains||[]).join("\n")}</textarea>
      <label>Block Domains (one per line)</label><textarea id="sc_block">${(sc.block_domains||[]).join("\n")}</textarea>
      <label>Render JS</label><input id="sc_render" type="checkbox" ${sc.render_js?"checked":""}>
      <div class="actions"><button id="saveScrape" class="primary">Save Scraper</button></div>
      <div id="msgScrape" class="ok"></div>
    `;

    const map = { catalog: catalogHTML, imap: imapHTML, scraper: scraperHTML };
    root.innerHTML = map[activeTab] || map.catalog;

    // Tab switch
    root.querySelectorAll('[data-tab]').forEach(btn => {
      btn.onclick = (ev) => viewSettings(ev.target.getAttribute('data-tab'));
    });

    // Save handlers
    if (activeTab === 'catalog') {
      $("#saveCatalog").onclick = async () => {
        const toList = (id) => $("#"+id).value.split(",").map(s=>s.trim()).filter(Boolean);
        const body = {
          countries: toList("cat_countries"),
          mccmnc: toList("cat_mccmnc"),
          vendors: toList("cat_vendors"),
          tags: toList("cat_tags"),
        };
        await authFetch("/conf/enums", {method:"POST", body: JSON.stringify(body)});
        $("#msgCat").textContent = "Catalog saved";
        viewSettings('catalog');
      };
    }
    if (activeTab === 'imap') {
      $("#saveImap").onclick = async () => {
        const body = {
          host: $("#im_host").value, port: Number($("#im_port").value),
          username: $("#im_user").value, password: $("#im_pass").value,
          ssl: $("#im_ssl").checked, folder: $("#im_folder").value,
          enabled: $("#im_enabled").checked
        };
        await authFetch("/settings/imap", {method:"POST", body: JSON.stringify(body)});
        $("#msgImap").textContent = "IMAP saved";
      };
    }
    if (activeTab === 'scraper') {
      $("#saveScrape").onclick = async () => {
        const body = {
          enabled: $("#sc_enabled").checked,
          interval_minutes: Number($("#sc_interval").value),
          user_agent: $("#sc_ua").value,
          max_concurrency: Number($("#sc_conc").value),
          start_urls: $("#sc_urls").value.split("\n").map(s=>s.trim()).filter(Boolean),
          allow_domains: $("#sc_allow").value.split("\n").map(s=>s.trim()).filter(Boolean),
          block_domains: $("#sc_block").value.split("\n").map(s=>s.trim()).filter(Boolean),
          render_js: $("#sc_render").checked
        };
        await authFetch("/settings/scrape", {method:"POST", body: JSON.stringify(body)});
        $("#msgScrape").textContent = "Scraper saved";
      };
    }
  }

  async function render(view) {
    try {
      await authFetch("/users/me"); // verify token
      nav.hidden = false;
      if (view === "offers") return viewOffers();
      if (view === "settings") return viewSettings('catalog');
      return viewDashboard();
    } catch { showLogin(); }
  }

  nav.addEventListener("click", (e) => {
    const v = e.target.getAttribute("data-view");
    if (!v) return;
    render(v);
  });
  $("#logout").onclick = () => { clearToken(); showLogin(); };

  render("dashboard");
})();
