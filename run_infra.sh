#!/bin/bash
set -euo pipefail

BRANCH="feature/infra-portainer-postgres"
PATCH="portainer-setup.patch"
CLEANUP=true

echo "๐ Starting fully-automated infrastructure setup..."
echo "๐ฆ Components: Portainer CE + PostgreSQL + App (auto-SSL)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1๏ธโฃ Validate Git environment
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ ! -d ".git" ]; then
  echo "โ Error: This directory is not a Git repository."
  exit 1
fi

if ! git remote get-url origin >/dev/null 2>&1; then
  echo "โ Error: No remote 'origin' configured. Clone from GitHub first."
  exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2๏ธโฃ Check for uncommitted changes
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if ! git diff-index --quiet HEAD --; then
  echo "โ๏ธ  Warning: You have uncommitted changes."
  echo "๐ก Please commit or stash them before running this script."
  exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3๏ธโฃ Ensure patch exists
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ ! -f "$PATCH" ]; then
  echo "โ Error: Patch file '$PATCH' not found."
  echo "๐ Please make sure '$PATCH' is in the project root."
  exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4๏ธโฃ Create or switch branch
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
  echo "๐ Branch '$BRANCH' already exists โ switching..."
  git checkout "$BRANCH"
else
  echo "๐ฑ Creating new branch '$BRANCH'..."
  git checkout -b "$BRANCH"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 5๏ธโฃ Apply patch safely
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ Checking patch integrity..."
if git apply --check "$PATCH" >/dev/null 2>&1; then
  echo "๐ฆ Applying patch..."
  git apply "$PATCH"
else
  echo "โ๏ธ  Patch appears already applied or conflicts detected."
  echo "๐ Aborting to prevent overwriting files."
  exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 6๏ธโฃ Commit and push
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
git add .
git commit -m "Add Portainer + PostgreSQL infrastructure stack"
git push -u origin "$BRANCH" || {
  echo "โ Push failed โ please check your network or authentication."
  exit 1
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 7๏ธโฃ Cleanup
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if [ "$CLEANUP" = true ] && [ -f "$PATCH" ]; then
  rm -f "$PATCH"
  echo "๐งน Cleaned up patch file."
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 8๏ธโฃ Provide direct PR link
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
REPO_URL=$(git config --get remote.origin.url | sed 's/.git$//')
[[ "$REPO_URL" == git@github.com:* ]] && REPO_URL="https://github.com/${REPO_URL#git@github.com:}"

echo "โ All done!"
echo "๐ Branch: $BRANCH"
echo "๐ Open Pull Request: $REPO_URL/compare/$BRANCH?expand=1"
echo "๐ Your infrastructure is ready โ you can now run:"
echo "    docker compose up -d"
